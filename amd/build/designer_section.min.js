define ("format_designer/designer_section",["jquery","core/loadingicon","core/ajax"],function(a,b,c){var d={ACTIVITYLI:"li.activity",SECTIONLI:"li.section",ACTIVITYACTION:"a.cm-edit-action",SECTIONACTIONMENU:".section_action_menu.designer-menu"};Y.use("moodle-course-coursebase",function(){var a=M.course.format.get_section_selector();if(a){d.SECTIONLI=a}});var e=function(b,c,e){var f=this;f.courseId=b;f.contextId=c;f.popupActivities=e;a("body").delegate(f.SectionController,"click",f.sectionLayoutaction.bind(this));a("body").delegate(f.RestrictInfo,"click",f.moduleHandler.bind(this));a("body").delegate(f.sectionRestricted,"click",this.sectionRestrictHandler.bind(this));a("body").delegate(f.fullDescription,"click",f.fullmodcontentHandler.bind(this));a("body").delegate(f.trimDescription,"click",f.trimmodcontentHandler.bind(this));a("body").on("click keypress",d.ACTIVITYLI+" "+d.ACTIVITYACTION+"[data-action]",this.editModuleRenderer.bind(this));a("body").delegate(f.goToURL,"click",f.redirectToModule.bind(this));window.onhashchange=function(){f.expandSection()};this.expandSection();if(0<a(".course-type-flow").length){a(".collapse").on("show.bs.collapse",function(){a(this).parents("li.section").addClass("stack-header-collapsing");var b=a(this).parents("li.section").attr("id"),c=document.getElementById(b),d=c.offsetTop-document.body.scrollTop;setTimeout(function(){return window.scroll(0,d)},50)}).on("shown.bs.collapse",function(){a(this).parents("li.section").removeClass("stack-header-collapsing")})}};e.prototype.goToURL=".designer [data-action=\"go-to-url\"]";e.prototype.SectionController=".designer #section-designer-action .dropdown-menu a";e.prototype.RestrictInfo=".designer .designer-section-content .call-action-block";e.prototype.moduleBlock=".designer .designer-section-content li.activity";e.prototype.loadingElement=".icon-loader-block";e.prototype.sectionRestricted=".designer .availability-section-block .section-restricted-action";e.prototype.moduleDescription=".designer .designer-section-content li .mod-description-action";e.prototype.fullDescription=".designer-section-content li .fullcontent-summary .mod-description-action";e.prototype.trimDescription=".designer-section-content li .trim-summary .mod-description-action";e.prototype.modules=null;e.prototype.addSectionSpinner=function(b){var c=a(b).addClass("editinprogress"),d=c.find("li.section").get(0);if(d){var e=M.util.add_spinner(Y,Y.Node(d));e.show();return e}return null};e.prototype.redirectToModule=function(a){var b=a.target.nodeName,c=a.target.closest("li.activity").classList.contains("circle-layout"),d=a.target.classList.contains("mod-description-action"),e=a.target.classList.contains("fa-lock"),f=a.target.closest("li.activity").classList.contains("popmodule");if(b in["a","button","form"]||document.body.classList.contains("editing")||c||d||e||f){if(f&&!document.body.classList.contains("editing")){var g=a.target.closest("li.activity");g.querySelector("a[href]").click()}return null}var h=a.target.closest("[data-action=go-to-url]"),i=h.getAttribute("data-url");window.location.href=i};e.prototype.expandSection=function(){var a=window.location.hash;if(a){var b=a.substring(1),c=document.getElementById(b);if(c){var d=c.querySelector(".section-header-content");if(d){d.classList.remove("collapsed");d.setAttribute("aria-expanded",!0)}var e=c.querySelector(".content");if(e){e.classList.add("show")}if(null!==document.getElementById("section-course-accordion")){document.getElementById("section-head-0").classList.add("collapsed");document.getElementById("section-content-0").classList.remove("show")}c.scrollIntoView()}}};e.prototype.removeSectionSpinner=function(b,c,d){var e=a(b);window.setTimeout(function(){e.removeClass("editinprogress");if(c){c.hide()}},d)};e.prototype.getModuleId=function(a){var b;Y.use("moodle-course-util",function(c){b=c.Moodle.core_course.util.cm.getId(c.Node(a.get(0)))});return b};e.prototype.refreshSectionInfo=function(b){var d=this,e=b.currentTarget.closest("li.section"),f=a(e).attr("data-id"),g=a(e).attr("data-sectionreturnid"),h=d.addSectionSpinner(e),i={courseid:d.courseId,sectionid:f,sectionreturn:g};window.setTimeout(function(b){var e=c.call([{methodname:"format_designer_section_refresh",args:b}],!0);a.when.apply(a,e).done(function(b){var c=a.parseJSON(b);if(c.modules!==void 0){for(var e in c.modules){d.replaceActivityhtml(c.modules[e])}}})},1e3,i);d.removeSectionSpinner(e,h,400)};e.prototype.editModuleRenderer=function(b){var c=this;if("keypress"===b.type&&13!==b.keyCode){return}var e=a(b.currentTarget),f=e.closest(d.ACTIVITYLI),g=e.attr("data-action"),h=c.getModuleId(f);switch(g){case"moveleft":case"moveright":case"delete":case"duplicate":case"hide":case"stealth":case"show":case"groupsseparate":case"groupsvisible":case"groupsnone":break;default:return;}if(!h){return}b.preventDefault();if("delete"===g){window.setTimeout(function(){a(".modal-footer button[data-action=\"save\"]").click(function(){c.refreshSectionInfo(b)})},500)}else{c.refreshSectionInfo(b)}};e.prototype.fullmodcontentHandler=function(b){var c=a(b.currentTarget),d=a(c).closest("li.activity").find(".fullcontent-summary"),e=a(c).closest("li.activity").find(".trim-summary");if(e.hasClass("summary-hide")){e.removeClass("summary-hide");d.addClass("summary-hide")}};e.prototype.trimmodcontentHandler=function(b){var c=a(b.currentTarget),d=a(c).closest("li.activity").find(".fullcontent-summary"),e=a(c).closest("li.activity").find(".trim-summary");if(d.hasClass("summary-hide")){d.removeClass("summary-hide");e.addClass("summary-hide")}};e.prototype.sectionRestrictHandler=function(b){var c=a(b.currentTarget).prev();if(c){if(!c.hasClass("show")){c.addClass("show")}else{c.removeClass("show")}}};e.prototype.moduleHandler=function(b){b.preventDefault();var c=a(b.currentTarget).parents(".restrict-block");if(c.length){if(!c.hasClass("show")){c.addClass("show")}else{c.removeClass("show")}}};e.prototype.sectionLayoutaction=function(d){var e=this,f=d.target.closest("li.section").getAttribute("id"),g="#"+f+" "+e.loadingElement,h=a(d.currentTarget).data("value"),i=a(d.currentTarget).text();a(d.target).parents(".dropdown").find(".btn").html(i);a(d.target).parents(".dropdown").find(".btn").val(h);a(d.target).parent().find("a.dropdown-item").each(function(){a(this).removeClass("active")});a(d.target).addClass("active");var j=d.target.closest("li.section").getAttribute("data-id"),k={courseid:e.courseId,sectionid:j,options:[{name:a(d.currentTarget).data("option"),value:h}]},l={cards:"card-deck card-layout",list:"list-layout",default:"link-layout",circles:"circles-layout",horizontal_circles:"circles-layout horizontal-circles-layout"},m=c.call([{methodname:"format_designer_set_section_options",args:k}],!0);a.when.apply(a,m).done(function(b){var c=a.parseJSON(b);if(c.modules!==void 0){for(var d in c.modules){e.replaceActivityhtml(c.modules[d])}document.getElementById(f).classList.forEach(function(a){if(a.startsWith("section-type-")){document.getElementById(f).classList.remove(a)}});document.getElementById(f).classList.add("section-type-"+h);a("#"+f).find("ul.section").removeClass(l.cards);a("#"+f).find("ul.section").removeClass(l.list);a("#"+f).find("ul.section").removeClass(l.default);a("#"+f).find("ul.section").removeClass(l.circles);a("#"+f).find("ul.section").addClass(l[h])}});b.addIconToContainerRemoveOnCompletion(g,m)};e.prototype.replaceActivityhtml=function(b){a("<div>"+b+"</div>").find(d.ACTIVITYLI).each(function(){var c=a(this).attr("id");a(d.ACTIVITYLI+"#"+c).replaceWith(b);f(c)})};var f=function(a){Y.use("moodle-course-coursebase",function(){M.course.coursebase.invoke_function("setup_for_resource","#"+a)});if(M.core.actionmenu&&M.core.actionmenu.newDOMNode){M.core.actionmenu.newDOMNode(Y.one("#"+a))}};return{init:function init(a,b,c){return new e(a,b,c)}}});
//# sourceMappingURL=designer_section.min.js.map
